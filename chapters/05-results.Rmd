# Results

```{r read-results}
rec_results  <- read_rds("data/sim-recovery.rds")
full_results <- read_rds("data/sim-allreps.rds")

rec_results <- rec_results %>%
  ungroup() %>%
  mutate(
    cond = factor(cond),
    attributes = factor(attributes, levels = c(3, 4), labels = c("3 Attributes",
      "4 Attributes")),
    sample_size = factor(sample_size),
    over_spec = factor(over_spec, levels = c(0, 0.1, 0.2),
      labels = c("Over Specification:\n0.0", "Over Specification:\n0.1",
        "Over Specification:\n0.2")),
    model = factor(model, levels = c("satr", "siml", "meas", "strc",
      "meas-strc", "strc-meas"), labels = c("Saturated", "Simultaneous",
        "Measurement", "Structural", "Measurement-Structural",
        "Structural-Measurement"))
  )
```

Results from the simulation study are described in two sections. Section \@ref(pval-results) summarizes the performance of the reduction processes when the parameters to reduce were determined by p-values from a converged model (i.e., p-value/p-value reduction). Section \@ref(heur-results) summarizes results of the reduction processes for models that did not converge, and the parameters to reduce were determined by the higher order interaction heuristic (i.e., heuristic/p-value reduction).

Table \@ref(tab:satr-converge) shows the convergence rates for the saturated model. As expected, the convergence rates decrease as the number of attributes increases, and decrease dramatically as the over specification of the Q-matrix increases. Interestingly, sample size had relatively little effect on the convergence rates of the saturated model, with rates staying fairly consistent with attribute and over specification conditions.

```{r satr-converge}
satr_con <- full_results %>%
  filter(model == "satr") %>%
  group_by(attributes, sample_size, over_spec) %>%
  summarize(convergence_rate = mean(converge)) %>%
  mutate(col_label = map2_chr(attributes, sample_size, function(x, y) {
    paste0(x, "_", y)
  })) %>%
  ungroup() %>%
  select(over_spec, col_label, convergence_rate) %>%
  spread(key = col_label, value = convergence_rate) %>%
  select(over_spec, `3_500`, `3_1000`, `3_5000`, `4_500`, `4_1000`, `4_5000`)

colnames(satr_con) <- c("Q-Matrix Over Specification", "n = 500", "n = 1000",
  "n = 5000", "n = 500", "n = 1000", "n = 5000")

knitr::kable(satr_con, align = "c", booktabs = TRUE,
  caption = "Saturated model convergence rates", format = knit_format) %>%
  kable_styling(latex_options = "hold_position") %>%
  add_header_above(c(" " = 1, "3 Attributes" = 3, "4 Attributes" = 3))
```

## Reduction by p-value {#pval-results}

```{r format-reps}
full_results <- full_results %>%
  ungroup() %>%
  mutate(
    cond = factor(cond),
    attributes = factor(attributes, levels = c(3, 4), labels = c("3 Attributes",
      "4 Attributes")),
    sample_size = factor(sample_size),
    over_spec = factor(over_spec, levels = c(0, 0.1, 0.2),
      labels = c("Over Specification:\n0.0", "Over Specification:\n0.1",
        "Over Specification:\n0.2")),
    model = factor(model, levels = c("satr", "siml", "meas", "strc",
      "meas-strc", "strc-meas"), labels = c("Saturated", "Simultaneous",
        "Measurement", "Structural", "Measurement-Structural",
        "Structural-Measurement"))
  )
```

```{r format-fit}
fit_results <- full_results %>%
  select(cond:model, satr_converge, converge, aic, bic, abic) %>%
  group_by(cond, attributes, sample_size, dataset, over_spec, satr_converge) %>%
  nest(.key = "fit_data") %>%
  mutate(
    aic = map_chr(.x = .data$fit_data, .f = function(x) {
      if (!any(x$converge, na.rm = TRUE)) return(NA_character_)
      
      pick <- x %>%
        filter(converge) %>%
        top_n(-1, aic) %>%
        top_n(1, model) %>%
        pull(model) %>%
        as.character()
      
      return(pick)
    }),
    bic = map_chr(.x = .data$fit_data, .f = function(x) {
      if (!any(x$converge, na.rm = TRUE)) return(NA_character_)
      
      pick <- x %>%
        filter(converge) %>%
        top_n(-1, bic) %>%
        top_n(1, model) %>%
        pull(model) %>%
        as.character()
      
      return(pick)
    }),
    abic = map_chr(.x = .data$fit_data, .f = function(x) {
      if (!any(x$converge, na.rm = TRUE)) return(NA_character_)
      
      pick <- x %>%
        filter(converge) %>%
        top_n(-1, abic) %>%
        top_n(1, model) %>%
        pull(model) %>%
        as.character()
      
      return(pick)
    }),
    aic = factor(aic, levels = c("Saturated", "Simultaneous", "Measurement",
      "Structural", "Measurement-Structural", "Structural-Measurement")),
    bic = factor(bic, levels = c("Saturated", "Simultaneous", "Measurement",
      "Structural", "Measurement-Structural", "Structural-Measurement")),
    abic = factor(abic, levels = c("Saturated", "Simultaneous", "Measurement",
      "Structural", "Measurement-Structural", "Structural-Measurement"))
  ) %>%
  select(-fit_data)
```

### Convergence

When saturated model converged, reduction of measurement and structural parameters proceeded by using p-values to determine which parameters to reduce. Figure \@ref(fig:pvalue-converge) shows the convergence rates for these reduction processes when the saturated model converged. Recall that measurement-structural and structural measurement reduction only occurred if the measurement and structural reductions, respectively, converged. Across all conditions, reduction processes where there measurement model was reduced first (i.e., simultaneous, measurement, and measurement-structural) tended to have higher convergence rates. This was most notable when the Q-matrix was over specified. In the most extreme case, the four-attribute condition with a 20 percent over specified Q-matrix, no reductions converged if the measurement model was not part of the initial reduction. However, because the saturated model very rarely converged for this condition (Table \@ref(tab:satr-converge)), the sample size is very limited.

```{r pvalue-converge, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Convergence rates when reducing using p-values", fig.pos = "H"}
p <- rec_results %>% 
  filter(satr_converge == TRUE) %>%
  ggplot(aes(x = sample_size, y = converge, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Convergence Rate", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "pvalue-converge.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-converge.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-converge.pdf")
} else {
  knitr::include_graphics("figure/pvalue-converge.png")
}
```

### Parameter recovery

To evaluate the performance of the reduction processes, the bias and mean square error of the parameter estimates can be examined. The bias represents the difference between the true value and the estimated value. The mean square error represents the average of the squared difference between the true and estimated values. Figure \@ref(fig:pvalue-bias) and Figure \@ref(fig:pvalue-mse) show the total bias and total mean square error, respectively, across all measurement model parameters when reducing using p-values. Because of some outlying data sets, biases with an absolute value greater than 100 and mean square errors with a value greater than 100 have been excluded from the figures. Figures showing all biases and mean square errors, separated by the type of parameter can be seen in Appendix \@ref(app-pval-recov).

```{r pvalue-bias, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Bias in measurement model main effect estimates when reducing using p-values", fig.pos = "H"}
p <- rec_results %>% 
  filter(satr_converge == TRUE) %>%
  mutate(
    total_bias = pmap_dbl(list(intercept_bias, main_effect_bias,
      interaction2_bias, interaction3_bias, interaction4_bias),
      function(x1, x2, x3, x4, x5) {
        sum(x1, x2, x3, x4, x5, na.rm = TRUE)
      })
  ) %>%
  filter(abs(total_bias) < 100) %>%
  ggplot(aes(x = sample_size, y = total_bias, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Average Bias", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "pvalue-bias.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-bias.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-bias.pdf")
} else {
  knitr::include_graphics("figure/pvalue-bias.png")
}
```

```{r pvalue-mse, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Mean square error in measurement model main effect estimates when reducing using p-values", fig.pos = "H"}
p <- rec_results %>% 
  filter(satr_converge == TRUE) %>%
  mutate(
    total_mse = pmap_dbl(list(intercept_mse, main_effect_mse,
      interaction2_mse, interaction3_mse, interaction4_mse),
      function(x1, x2, x3, x4, x5) {
        sum(x1, x2, x3, x4, x5, na.rm = TRUE)
      })
  ) %>%
  mutate(total_mse = case_when(total_mse <= 100 ~ total_mse, TRUE ~ NA_real_)) %>%
  ggplot(aes(x = sample_size, y = total_mse, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Average Mean Square Error", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "pvalue-mse.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-mse.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-mse.pdf")
} else {
  knitr::include_graphics("figure/pvalue-mse.png")
}
```

Figure \@ref(fig:pvalue-bias) shows that across all conditions there is relatively little bias in the measurement model parameters. This is especially true when the Q-matrix is correctly specified. The large negative bias seen in the measurement reduction condition for the three attribute and 10 percent over specified Q-matrix is due to a single three way interaction in one data set, as can be seen in Figure \@ref(fig:pvalue-int3-bias). In contrast, there is relatively large mean square error values across conditions. As expected, this decreases as the sample size increases. Thus, these results suggest that larger sample sizes (i.e., greater than 1,000) are needed in order to ensure unbiased estimates of measurement model parameters with low levels of error.

Figure \@ref(fig:pvalue-strc-bias) and Figure \@ref(fig:pvalue-strc-mse) show the bias and mean square error of the structural parameters respectively. Overall, there is very little bias and mean squared error in the structural parameters. The instances where larger bias and mean squared error are indicated (e.g., measurement reduction of a four attribute model with a 20% over specified Q-matrix) are instances where very few of the model actually converged. Thus, these values are based on only a few replications. Thus, these results suggests that given model convergence, the structural parameters are usually well estimated regardless of model reduction method.

```{r pvalue-strc-bias, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Bias in structrual model parameter estimates when reducing using p-values", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == TRUE) %>%
  mutate(structural_bias = case_when(structural_bias <= 100 ~ structural_bias,
    TRUE ~ NA_real_)) %>%
  ggplot(aes(x = sample_size, y = structural_bias, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Average Bias", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "pvalue-strc-bias.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-strc-bias.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-strc-bias.pdf")
} else {
  knitr::include_graphics("figure/pvalue-strc-bias.png")
}
```

```{r pvalue-strc-mse, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Mean square error in structrual model parameter estimates when reducing using p-values", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == TRUE) %>%
  mutate(structural_mse = case_when(structural_mse <= 100 ~ structural_mse,
    TRUE ~ NA_real_)) %>%
  ggplot(aes(x = sample_size, y = structural_mse, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Average Mean Square Error", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "pvalue-strc-mse.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-strc-mse.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-strc-mse.pdf")
} else {
  knitr::include_graphics("figure/pvalue-strc-mse.png")
}
```

### Mastery classification

Another critical measure of performance is the rate at which respondents are correctly classified as masters of the attributes. This is assessed at two levels: the individual attribute classifications, and the overall profile classification. As described in section \@ref(method-outcome), profile mastery and attribute mastery differentiate between two types of assignments that can occur. For example, a respondent may have a true profile of [1,0,1,0] and an estimated profile of [1,1,1,0]. Here, the overall profile assignment is incorrect (profile classification), but three out of the four individual attributes are correctly classified (attribute classification). Respondents were classified as a master of an attribute if their posterior probability of mastery was greater than or equal to .5, and non-master of the attribute otherwise. Figure \@ref(fig:pvalue-attr-ccr) and Figure \@ref(fig:pvalue-attr-kap) show the attribute level agreement as measured by the average correct classification rate and average Cohen's $\kappa$, respectively.

(ref:pvalue-kap-attr) Average Cohen's $\kappa$ of attribute mastery when reducing using p-values

(ref:pvalue-kap-prof) Average Cohen's $\kappa$ of profile assignment when reducing using p-values

```{r pvalue-attr-ccr, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Average correct classification rate of attribute mastery when reducing using p-values", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == TRUE) %>%
  ggplot(aes(x = sample_size, y = attribute_ccr, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Attribute Correct Classification Rate", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "pvalue-attr-ccr.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-attr-ccr.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-attr-ccr.pdf")
} else {
  knitr::include_graphics("figure/pvalue-attr-ccr.png")
}
```

```{r pvalue-attr-kap, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "(ref:pvalue-kap-attr)", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == TRUE) %>%
  ggplot(aes(x = sample_size, y = attribute_kappa, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = expression("Average Attribute Cohen's "*kappa), fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "pvalue-attr-kap.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-attr-kap.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-attr-kap.pdf")
} else {
  knitr::include_graphics("figure/pvalue-attr-kap.png")
}
```

Across all conditions, both the correct classification rate and Cohen's $\kappa$ show high rates of agreement between true and estimated attribute classifications. The exception is a four-attribute assessment with a sample size of only 500. Under these conditions, all model reduction processes showed lower rates of agreement than with larger samples or only three attributes.

The overall profile classification shows a similar pattern. Figure \@ref(fig:pvalue-prof-ccr) and Figure \@ref(fig:pvalue-prof-kap) show the correct classification rate and Cohen's $\kappa$ of the overall profiles. As expected, the overall profile agreement is consistently lower than the attribute level mastery classification agreement, although the classification agreement is generally consistent across all model reduction processes. Additionally, as with the attribute classifications, profile classification agreement was lower in the four-attribute, 500 sample size conditions.

```{r pvalue-prof-ccr, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Average correct classification rate of profile assignment when reducing using p-values", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == TRUE) %>%
  ggplot(aes(x = sample_size, y = profile_ccr, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Profile Correct Classification Rate", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "pvalue-prof-ccr.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-prof-ccr.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-prof-ccr.pdf")
} else {
  knitr::include_graphics("figure/pvalue-prof-ccr.png")
}
```

```{r pvalue-prof-kap, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "(ref:pvalue-kap-prof)", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == TRUE) %>%
  ggplot(aes(x = sample_size, y = profile_kappa, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = expression("Average Profile Cohen's "*kappa),
    fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "pvalue-prof-kap.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-prof-kap.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-prof-kap.pdf")
} else {
  knitr::include_graphics("figure/pvalue-prof-kap.png")
}
```

### Model fit

Critical to the model selection process is model fit. Although different model reduction processes may all show adequate recovery of item parameters and respondent classification, these measures cannot provide insight as to whether or not the removal of the parameters significantly impacted model fit. Figure \@ref(fig:pvalue-aic), Figure \@ref(fig:pvalue-bic), and Figure \@ref(fig:pvalue-abic) show how many times the AIC, BIC, and adjusted BIC, respectively, selected each model reduction as the preferred model for a given data set.

Figure \@ref(fig:pvalue-aic) shows a strong preference for the saturated model when using the AIC to pick the preferred model. This indicates that the additional parameters in the saturated model provide enough improvement to model fit to justify the additional complexity. However, structural reduction was also selected fairly often, especially in the true Q-matrix conditions. This suggests that the full structural model was often overly complex, and a reduced version provied adequate fit.

```{r pvalue-aic, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Number of selections as best fitting model as measured by the AIC when reducing using p-values", fig.pos = "H"}
p <- fit_results %>%
  filter(satr_converge == TRUE) %>%
  group_by(attributes, sample_size, over_spec, aic) %>%
  summarize(picks = n()) %>%
  complete(attributes, sample_size, over_spec, aic, fill = list(picks = 0)) %>%
  ggplot(aes(x = sample_size, y = picks, group = aic, fill = aic)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  labs(x = "Sample Size", y = "AIC Selections", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "pvalue-aic.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-aic.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-aic.pdf")
} else {
  knitr::include_graphics("figure/pvalue-aic.png")
}
```

The BIC shows very different results (Figure \@ref(fig:pvalue-bic)). When selecting a model based on the BIC, the preferred method was most commonly structural-measurement, followed by measurement-structural reduction. This may be unsurprising, as the penalty for additional parameters is greater in the BIC than the AIC [@wit_all_2012_fix]. Therefore, the BIC is more likely to prefer models with fewer parameters. However, when the Q-matrix is correctly specified, the preference for the saturated model increases as the sample size increases. This indicates that model reduction may be more important when sample sizes are smaller, and it is more difficult to get good parameter estimates.

```{r pvalue-bic, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Number of selections as best fitting model as measured by the BIC when reducing using p-values", fig.pos = "H"}
p <- fit_results %>%
  filter(satr_converge == TRUE) %>%
  group_by(attributes, sample_size, over_spec, bic) %>%
  summarize(picks = n()) %>%
  complete(attributes, sample_size, over_spec, bic, fill = list(picks = 0)) %>%
  ggplot(aes(x = sample_size, y = picks, group = bic, fill = bic)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  labs(x = "Sample Size", y = "BIC Selections", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "pvalue-bic.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-bic.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-bic.pdf")
} else {
  knitr::include_graphics("figure/pvalue-bic.png")
}
```

Finally, results when using the adjusted BIC show a middle ground between the results when using the AIC or BIC (Figure \@ref(fig:pvalue-abic)). There is still a strong preference for the saturated model, however, there is also a stronger preference for the structural-measurement and measurement-structural reductions than what was seen when using the AIC.

```{r pvalue-abic, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Number of selections as best fitting model as measured by the adjusted BIC when reducing using p-values", fig.pos = "H"}
p <- fit_results %>%
  filter(satr_converge == TRUE) %>%
  group_by(attributes, sample_size, over_spec, abic) %>%
  summarize(picks = n()) %>%
  complete(attributes, sample_size, over_spec, abic, fill = list(picks = 0)) %>%
  ggplot(aes(x = sample_size, y = picks, group = abic, fill = abic)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  labs(x = "Sample Size", y = "Adjusted BIC Selections", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "pvalue-abic.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-abic.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-abic.pdf")
} else {
  knitr::include_graphics("figure/pvalue-abic.png")
}
```

### Description of reduced parameters {#pval-descrip}

Another outcome of interest beyond the recovery of the generated parameters is how often each reduction process resulted in the correct parameters being included in the final model. For example, if an item measured only one attribute, but the Q-matrix specified two attributes, were the additional main effect and interaction term correctly removed? Conversely, if an item did in fact measure two attributes, were both main effects and the interaction term correctly retained? Figure \@ref(fig:pvalue-correct-meas) shows the proportion of time the measurement model was correctly reduced, and Figure \@ref(fig:pvalue-correct-strc) shows the proportion of correct reductions for the structural model. 

```{r pvalue-correct-meas, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Proportion of correct measurement model reductions when reducing with p-values", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == TRUE) %>%
  ggplot(aes(x = sample_size, y = correct_meas, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Propostion of Correct Reductions",
    fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "pvalue-correct-meas.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-correct-meas.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-correct-meas.pdf")
} else {
  knitr::include_graphics("figure/pvalue-correct-meas.png")
}
```

```{r pvalue-correct-strc, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Proportion of correct structural model reductions when reducing with p-values", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == TRUE) %>%
  ggplot(aes(x = sample_size, y = correct_strc, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Proportion of Correct Reductions",
    fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "pvalue-correct-strc.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-correct-strc.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-correct-strc.pdf")
} else {
  knitr::include_graphics("figure/pvalue-correct-strc.png")
}
```

Figure \@ref(fig:pvalue-correct-meas) shows that the only cases where the correct measurement model was obtained was when it was correctly specified, and no parameters were removed (i.e., saturated model or only structural reduction). These results should be interpreted with caution. A "correct" measurement model is defined as all parameters in the final model exactly matching the parameters used to generate the data. This does not account, however, for parameters that may have contributed to the data generation, but not in a significant way. For example, the main effects were drawn from a uniform distribution (0.00, 5.00]. Thus, it is entirely plausible, and expected, for main effects with a value close to zero to be drawn. Thus, these parameters would technically be part of the true measurement model, but may not be statistically significant, and even one of these parameters would result in the determination of an incorrect measurement model.

A similar pattern is seen in Figure \@ref(fig:pvalue-correct-strc), with very low rates of correct reduction, except when no reduction of the structural model was performed (i.e., saturated model or only measurement reduction). Because the data was always generated with a fully saturated log-linear structural model, and reduction of the structural model results in a determination of an incorrect reduction. However, given that the structural parameters were all drawn from a $\mathcal{N}(0, 2)$ distribution the same caveats of significance apply that applied to the measurement model parameters.

To verify that the parameters being reduced are indeed these parameters that are very small, and thus may not be significant, the distributions of estimates and standard errors of the reduced parameters can be examined. Figure \@ref(fig:pvalue-meas-params) shows that the majority of reduced measurement model parameters are small in value, with small standard errors. More parameters were removed from the true Q-matrix conditions than the over specified Q-matrix conditions, however this is an artifact of the over specified conditions converging far less often.

Figure \@ref(fig:pvalue-strc-params) shows a similar pattern for the structural parameters, with the majority of reduced parameters having an estimate close to zero. Additionally, the most of the reduction occurred out of the true Q-matrix conditions, as the over specification conditions often failed to converge. However, unlike the measurement model parameters, there is more variability in the estimates and standard errors of the parameters that were reduced. 

```{r pvalue-meas-params, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Distributions of estimates and standard errors for reduced measurement model parameters when reducing with p-values", fig.pos = "H"}
p <- full_results %>%
  filter(satr_converge == TRUE, model != "Saturated", !is.na(converge)) %>%
  select(cond:rm_param) %>%
  unnest() %>%
  filter(type != "structural", se != 0) %>%
  filter(!is.na(se), !is.na(est)) %>%
  filter(est > -2, se < 5) %>%
  mutate(
    est_cat = cut(est, c(seq(-2, 3, by = 1), Inf), right = FALSE,
      labels = seq(-2, 3, 1)),
    se_cat = cut(se, c(seq(0, 5, by = 0.5), Inf), right = FALSE,
      labels = sprintf("%0.1f", seq(0, 5, by = 0.5)))
  ) %>%
  group_by(model, over_spec, est_cat, se_cat) %>%
  summarize(n = n()) %>%
  ggplot(aes(x = est_cat, y = se_cat)) +
  facet_grid(model ~ over_spec, scales = "free") +
  geom_tile(aes(fill = n)) +
  scale_fill_viridis_c() +
  labs(x = "Estimate", y = "Standard Error", fill = "Number of Parameters") +
  theme_bw() +
  theme(legend.position = "bottom", axis.text = element_text(size = 8),
    legend.key.width = unit(0.75, "inches"))

ggsave(filename = "pvalue-meas-params.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-meas-params.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-meas-params.pdf")
} else {
  knitr::include_graphics("figure/pvalue-meas-params.png")
}
```

```{r pvalue-strc-params, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Distributions of estimates and standard errors for reduced structural model parameters when reducing with p-values", fig.pos = "H"}
p <- full_results %>%
  filter(satr_converge == TRUE, model != "Saturated", !is.na(converge)) %>%
  select(cond:rm_param) %>%
  unnest() %>%
  filter(type == "structural", se != 0) %>%
  filter(!is.na(se), !is.na(est)) %>%
  filter(est > -2, se < 5) %>%
  mutate(
    est_cat = cut(est, c(seq(-2, 3, by = 1), Inf), right = FALSE,
      labels = seq(-2, 3, by = 1)),
    se_cat = cut(se, c(seq(0, 5, by = 0.5), Inf), right = FALSE,
      labels = sprintf("%0.1f", seq(0, 5, 0.5)))
  ) %>%
  group_by(model, over_spec, est_cat, se_cat) %>%
  summarize(n = n()) %>%
  ggplot(aes(x = est_cat, y = se_cat)) +
  facet_grid(model ~ over_spec, scales = "free") +
  geom_tile(aes(fill = n)) +
  scale_fill_viridis_c() +
  labs(x = "Estimate", y = "Standard Error", fill = "Number of Parameters") +
  theme_bw() +
  theme(legend.position = "bottom", axis.text = element_text(size = 8),
    legend.key.width = unit(0.75, "inches"))

ggsave(filename = "pvalue-strc-params.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "pvalue-strc-params.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/pvalue-strc-params.pdf")
} else {
  knitr::include_graphics("figure/pvalue-strc-params.png")
}
```

## Reduction by heuristic {#heur-results}

When the saturated model failed to converge, high level interaction parameters (i.e., three- and four-way interactions) were selected for reduction from the measurement and structural models. Following this initial heuristic reduction, if the model converged, the reduction processes continued using p-values (Figure \@ref(fig:sim-process)). Whereas section \@ref(pval-results) described the performance of model that were reduced using p-values at all steps of model reduction, this section describes the second scenario, where models were reduced with the heuristic first, and then p-values.

### Convergence

Figure \@ref(fig:rule-converge) shows the convergence rates for these reduction processes when the saturated model failed to converge. Recall that measurement-structural and structural measurement reduction only occurred if the measurement and structural reductions using the heuristic, respectively, converged. When the Q-matrix is correctly specified, reduction of the structural model led to convergence the majority of the time. Conversely, the removal of three- and four-way interactions in the measurement model never led to convergence, unless the structural was being reduced simultaneously. The measurement model was able to be reduced by p-values, but only after higher order interactions had been reduced from the structural model.

```{r rule-converge, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Convergence rates when reducing using a heuristic", fig.pos = "H"}
p <- rec_results %>% 
  filter(satr_converge == FALSE) %>%
  ggplot(aes(x = sample_size, y = converge, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Convergence Rate", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "rule-converge.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "rule-converge.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/rule-converge.pdf")
} else {
  knitr::include_graphics("figure/rule-converge.png")
}
```

In contrast to the truly specified Q-matrix conditions, models rarely converged when the Q-matrix was over specified, regardless of reduction process. This was especially true as the complexity and amount of over specification increased. However, across these conditions, simultaneous reductions and measurement model reduction had the most success in getting the model to converge.

### Parameter recovery

As with the reduction process that relied entirely on p-values, the bias and mean square error of the parameter estimates can be examined for models that used the heuristic as the first reduction step. Figure \@ref(fig:rule-bias) and Figure \@ref(fig:rule-mse) show the total bias and total mean square error, respectively, across all measurement model parameters when reducing using p-values. As with the Because of some outlying data sets, biases with an absolute value greater than 100 and mean square errors with a value greater than 100 have been excluded from the figures. Figures showing all biases and mean square errors, separated by the type of parameter can be seen in Appendix \@ref(app-rule-recov).

```{r rule-bias, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Bias in measurement model main effect estimates when reducing using a heuristic", fig.pos = "H"}
p <- rec_results %>% 
  filter(satr_converge == FALSE) %>%
  mutate(
    total_bias = pmap_dbl(list(intercept_bias, main_effect_bias,
      interaction2_bias, interaction3_bias, interaction4_bias),
      function(x1, x2, x3, x4, x5) {
        sum(x1, x2, x3, x4, x5, na.rm = TRUE)
      })
  ) %>%
  filter(abs(total_bias) < 100) %>%
  ggplot(aes(x = sample_size, y = total_bias, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Average Bias", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "rule-bias.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "rule-bias.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/rule-bias.pdf")
} else {
  knitr::include_graphics("figure/rule-bias.png")
}
```

```{r rule-mse, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Mean square error in measurement model main effect estimates when reducing using a heuristic", fig.pos = "H"}
p <- rec_results %>% 
  filter(satr_converge == FALSE) %>%
  mutate(
    total_mse = pmap_dbl(list(intercept_mse, main_effect_mse,
      interaction2_mse, interaction3_mse, interaction4_mse),
      function(x1, x2, x3, x4, x5) {
        sum(x1, x2, x3, x4, x5, na.rm = TRUE)
      })
  ) %>%
  mutate(total_mse = case_when(total_mse <= 100 ~ total_mse, TRUE ~ NA_real_)) %>%
  ggplot(aes(x = sample_size, y = total_mse, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Average Mean Square Error", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "rule-mse.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "rule-mse.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/rule-mse.pdf")
} else {
  knitr::include_graphics("figure/rule-mse.png")
}
```

Figure \@ref(fig:rule-bias) shows that across all conditions, as with p-value based reduction, there is relatively little bias in the measurement model parameters, especially  when the Q-matrix is correctly specified. The large negative biases seen in the structural-measurement reduction condition for the three attribute and 10 percent over specified Q-matrix are due to a couple of outlying data, as can be seen in Appendix \@ref(app-rule-recov). Also similar to the reduction processes based entirely on p-values, there is relatively large mean square error values across conditions. As expected, and as with the p-value reduction, this decreases as the sample size increases.

Figure \@ref(fig:rule-strc-bias) and Figure \@ref(fig:rule-strc-mse) show the bias and mean square error of the structural parameters respectively. Overall, there is very little bias and mean squared error in the structural parameters. The instances where larger bias and mean squared error are indicated (e.g., 10 and 20 percent over specified Q-matrix) are instances where very few of the model actually converged. Thus, these values are based on only a few replications. Thus, these results suggests that, as with p-value only reduction, the structural parameters are usually well estimated regardless of model reduction method.

```{r rule-strc-bias, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Bias in structrual model parameter estimates when reducing using a heuristic", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == FALSE) %>%
  mutate(structural_bias = case_when(structural_bias <= 100 ~ structural_bias,
    TRUE ~ NA_real_)) %>%
  ggplot(aes(x = sample_size, y = structural_bias, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Average Bias", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "rule-strc-bias.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "rule-strc-bias.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/rule-strc-bias.pdf")
} else {
  knitr::include_graphics("figure/rule-strc-bias.png")
}
```

```{r rule-strc-mse, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Mean square error in structrual model parameter estimates when reducing using a heuristic", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == FALSE) %>%
  mutate(structural_mse = case_when(structural_mse <= 100 ~ structural_mse,
    TRUE ~ NA_real_)) %>%
  ggplot(aes(x = sample_size, y = structural_mse, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Average Mean Square Error", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "rule-strc-mse.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "rule-strc-mse.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/rule-strc-mse.pdf")
} else {
  knitr::include_graphics("figure/rule-strc-mse.png")
}
```

### Mastery classification

Just as with reduction based on p-values, it is important to evaluate mastery classification (at the attribute and profile level) when the initial reduction step is based on a heuristic. Figure \@ref(fig:rule-attr-ccr) and Figure \@ref(fig:rule-attr-kap) show the attribute level agreement as measured by the average correct classification rate and average Cohen's $\kappa$, respectively.

(ref:rule-kap-attr) Average Cohen's $\kappa$ of attribute mastery when reducing using a heuristic

(ref:rule-kap-prof) Average Cohen's $\kappa$ of profile assignment when reducing using a heuristic

```{r rule-attr-ccr, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Average correct classification rate of attribute mastery when reducing using a heuristic", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == FALSE) %>%
  ggplot(aes(x = sample_size, y = attribute_ccr, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Attribute Correct Classification Rate", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "rule-attr-ccr.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "rule-attr-ccr.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/rule-attr-ccr.pdf")
} else {
  knitr::include_graphics("figure/rule-attr-ccr.png")
}
```

```{r rule-attr-kap, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "(ref:rule-kap-attr)", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == FALSE) %>%
  ggplot(aes(x = sample_size, y = attribute_kappa, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = expression("Average Attribute Cohen's "*kappa), fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "rule-attr-kap.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "rule-attr-kap.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/rule-attr-kap.pdf")
} else {
  knitr::include_graphics("figure/rule-attr-kap.png")
}
```

Across all conditions, both the correct classification rate and Cohen's $\kappa$ show high rates of agreement between true and estimated attribute classifications, just as was observed when using p-values for all reductions.

The overall profile classification shows also shows pattern similar to the p-value only reduction (Figure \@ref(fig:rule-prof-ccr) and Figure \@ref(fig:rule-prof-kap)). The overall profile agreement is consistently lower than the mastery classification at the attribute but, but the profile agreement is generally consistent across all model reduction processes.

```{r rule-prof-ccr, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Average correct classification rate of profile assignment when reducing using a heuristic", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == FALSE) %>%
  ggplot(aes(x = sample_size, y = profile_ccr, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Profile Correct Classification Rate", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "rule-prof-ccr.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "rule-prof-ccr.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/rule-prof-ccr.pdf")
} else {
  knitr::include_graphics("figure/rule-prof-ccr.png")
}
```

```{r rule-prof-kap, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "(ref:rule-kap-prof)", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == FALSE) %>%
  ggplot(aes(x = sample_size, y = profile_kappa, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = expression("Average Profile Cohen's "*kappa),
    fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "rule-prof-kap.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "rule-prof-kap.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/rule-prof-kap.pdf")
} else {
  knitr::include_graphics("figure/rule-prof-kap.png")
}
```

### Model fit

When the saturated model fails to converge and the model reduction process uses a heuristic to remove parameters, it is still important to assess model fit. Figure \@ref(fig:rule-aic) shows the results when using the AIC to select the preferred model. When the Q-matrix is correclty specified, there is a strong preference for structural reduction over structural-measurement redcution. In contrast, when the Q-matrix is over specified, there is a stronger preference for simultaneous reduction of structural and measurement models. This preference is stronger as the amount of over specification increases.

```{r rule-aic, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Number of selections as best fitting model as measured by the AIC when reducing using a heuristic", fig.pos = "H"}
p <- fit_results %>%
  filter(satr_converge == FALSE) %>%
  group_by(attributes, sample_size, over_spec, aic) %>%
  summarize(picks = n()) %>%
  complete(attributes, sample_size, over_spec, aic, fill = list(picks = 0)) %>%
  filter(!is.na(aic)) %>%
  ggplot(aes(x = sample_size, y = picks, group = aic, fill = aic)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  labs(x = "Sample Size", y = "AIC Selections", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "rule-aic.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "rule-aic.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/rule-aic.pdf")
} else {
  knitr::include_graphics("figure/rule-aic.png")
}
```

The BIC results in Figure \@ref(fig:rule-bic) are similar to those seen when reduction depends only on p-values. There is a much stronger preference for structural-measurement and measurement-structural reduction than when using AIC. However, the difference is not as pronounced as with p-value only reduction, as simultaneous reduction is still preferred overall. Further, just as with the AIC, the preference for measurement reduction increases as the amount of over specification increases.

```{r rule-bic, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Number of selections as best fitting model as measured by the BIC when reducing using a heuristic", fig.pos = "H"}
p <- fit_results %>%
  filter(satr_converge == FALSE) %>%
  group_by(attributes, sample_size, over_spec, bic) %>%
  summarize(picks = n()) %>%
  complete(attributes, sample_size, over_spec, bic, fill = list(picks = 0)) %>%
  filter(!is.na(bic)) %>%
  ggplot(aes(x = sample_size, y = picks, group = bic, fill = bic)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  labs(x = "Sample Size", y = "BIC Selections", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "rule-bic.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "rule-bic.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/rule-bic.pdf")
} else {
  knitr::include_graphics("figure/rule-bic.png")
}
```

The model selection when using the adjusted BIC is also reflective of the results found when using only p-values (Figure \@ref(fig:rule-abic)). That is, the adjusted BIC serves as a middle ground between the AIC and the BIC. There is a stronger preference for the structural-measurement and measurement-structural reduction processes than when using the AIC, but not as strong when using the BIC. Additionally, there is a stronger preference for measurement model reduction as the amount of over specification in the Q-matrix increases.

```{r rule-abic, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Number of selections as best fitting model as measured by the adjusted BIC when reducing using a heuristic", fig.pos = "H"}
p <- fit_results %>%
  filter(satr_converge == FALSE) %>%
  group_by(attributes, sample_size, over_spec, abic) %>%
  summarize(picks = n()) %>%
  complete(attributes, sample_size, over_spec, abic, fill = list(picks = 0)) %>%
  filter(!is.na(abic)) %>%
  ggplot(aes(x = sample_size, y = picks, group = abic, fill = abic)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  labs(x = "Sample Size", y = "Adjusted BIC Selections", fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "rule-abic.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "rule-abic.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/rule-abic.pdf")
} else {
  knitr::include_graphics("figure/rule-abic.png")
}
```

### Description of reduced parameters

Finally, the performance of the different processes in terms of correctly specifying the parameters to be included can be examined. Figure \@ref(fig:rule-correct-meas) shows the proportion of time the measurement model was correctly reduced, and Figure \@ref(fig:rule-correct-strc) shows the proportion of correct reductions for the structural model. 

```{r rule-correct-meas, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Proportion of correct measurement model reductions when reducing with a heuristic", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == FALSE) %>%
  mutate(correct_meas = case_when(
    over_spec == "Over Specification:\n0.0" & model %in% c("Measurement",
      "Measurement-Structural") ~ 1,
    TRUE ~ correct_meas
  )) %>%
  ggplot(aes(x = sample_size, y = correct_meas, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Propostion of Correct Reductions",
    fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "rule-correct-meas.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "rule-correct-meas.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/rule-correct-meas.pdf")
} else {
  knitr::include_graphics("figure/rule-correct-meas.png")
}
```

```{r rule-correct-strc, fig.width = 8, fig.height = 8, out.width = "90%", fig.cap = "Proportion of correct structural model reductions when reducing with a heuristic", fig.pos = "H"}
p <- rec_results %>%
  filter(satr_converge == FALSE) %>%
  mutate(correct_strc = case_when(
    over_spec == "Over Specification:\n0.0" & model %in% c("Measurement") ~ 1,
    TRUE ~ correct_strc
  )) %>%
  ggplot(aes(x = sample_size, y = correct_strc, group = model, fill = model)) +
  facet_grid(over_spec ~ attributes) +
  geom_col(width = 0.7, position = position_dodge(width = 0.7)) +
  scale_fill_OkabeIto() +
  expand_limits(y = c(0, 1)) +
  labs(x = "Sample Size", y = "Proportion of Correct Reductions",
    fill = "Reduction\nProcess") +
  theme_bw() +
  theme(legend.position = "bottom", panel.grid.major.x = element_blank())

ggsave(filename = "rule-correct-strc.pdf", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")
ggsave(filename = "rule-correct-strc.png", plot = p, path = "figure", width = 8,
  height = 8, units = "in", dpi = "retina")

if (knitr::is_latex_output()) {
  knitr::include_graphics("figure/rule-correct-strc.pdf")
} else {
  knitr::include_graphics("figure/rule-correct-strc.png")
}
```

Figure \@ref(fig:rule-correct-meas) shows that the only cases where the correct measurement model was obtained was when it was correctly specified, and no parameters were removed using p-values (i.e., simultaneous, measurement, structural, or measurement-structural reduction). However, this should be interpreted with caution. When the Q-matrix is correctly specified, there are no three- and four-way interactions, thus, the heuristic has no parameters to remove. When the Q-matrix is over-specified, removing three- and four-way interactions does nothing to fix the additional main effects that have been added to the model.

Additionally, Figure \@ref(fig:rule-correct-strc), shows that the structural model most usually only correct when only the measurement model was reduced. This is because the data was always generated with a fully saturated structural model. Thus, any removal of parameters (including three- and four-way interactions) results in an incorrect final model.
